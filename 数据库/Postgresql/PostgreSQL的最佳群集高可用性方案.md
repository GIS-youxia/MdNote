# 【PostgreSQL架构】PostgreSQL的最佳群集高可用性方案 - 云+社区 - 腾讯云
如果您的系统依赖 PostgreSQL[数据库](https://cloud.tencent.com/solution/database?from=10680)并且您正在寻找 HA 的集群解决方案，我们希望提前告知您这是一项复杂的任务，但并非不可能实现。

我们将讨论一些解决方案，您可以从中选择对您的容错要求。

PostgreSQL 本身不支持任何多主群集解决方案，例如 MySQL 或 Oracle。尽管如此，仍有许多商业和社区产品提供此实现，以及其他产品，例如 PostgreSQL 的复制或负载平衡。

首先，让我们回顾一些基本概念：

它是服务可用的时间量，通常由企业定义。

冗余是高可用性的基础；万一发生事故，我们可以继续毫无问题地运转。

如果发生事件，则必须还原备份，然后应用 wal 日志；恢复时间将非常长，我们不会谈论高可用性。

但是，如果我们将备份和日志存档在应急服务器中，则可以在日志到达时应用它们。

如果日志每隔 1 分钟发送和应用一次，则应急基础将处于连续恢复状态，并且到生产的时间最多为 1 分钟。

备用数据库的想法是保留生产数据库的副本，该副本始终具有相同的数据，并且可以在发生事件时使用。

有几种方法可以对备用数据库进行分类：

根据复制的性质：

-   物理备用数据库：复制磁盘块。
-   逻辑备用数据库：流式传输数据更改。

通过事务的同步性：

-   异步：可能会丢失数据。
-   同步：不会丢失数据；主服务器中的提交等待备用服务器的响应。

通过用法：

-   热备用：它们不支持连接。
-   热备用：支持只读连接。

![](https://ask.qcloudimg.com/http-save/yehe-1589852/9yalbu3wdc.jpeg?imageView2/2/w/1620)

群集是一组一起工作的主机，被视为一个主机。

这提供了一种实现水平可伸缩性的方法，并提供了通过添加服务器来处理更多工作的能力。

它可以抵抗节点的故障并继续透明地工作。

根据共享的内容，有两种模型：

![](https://ask.qcloudimg.com/http-save/yehe-1589852/6vbqlc2ipd.jpeg?imageView2/2/w/1620)

-   共享存储：所有节点都使用相同的信息访问相同的存储。
-   不共享：每个节点都有自己的存储，取决于我们系统的结构，该存储可能与其他节点具有相同的信息。

现在让我们回顾一下 PostgreSQL 中的一些集群选项。

DRBD 是一个 Linux 内核模块，可使用网络实现同步块复制。它实际上不实现群集，也不处理故障转移或监视。为此，您需要补充软件，例如 Corosync + Pacemaker + DRBD。

![](https://ask.qcloudimg.com/http-save/yehe-1589852/ck66mv8tmk.jpeg?imageView2/2/w/1620)

例：

-   Corosync：处理主机之间的消息。
-   Pacemaker：启动和停止服务，确保它们仅在一台主机上运行。
-   DRBD：在块设备级别同步数据。

![](https://ask.qcloudimg.com/http-save/yehe-1589852/q7lfrew9jx.jpeg?imageView2/2/w/1620)

ClusterControl 是用于数据库集群的无代理管理和自动化软件。它可直接从其用户界面帮助部署，监视，管理和扩展数据库服务器 / 集群。

ClusterControl 能够处理维护数据库服务器或群集所需的大多数管理任务。

![](https://ask.qcloudimg.com/http-save/yehe-1589852/hxzu2r83o7.jpeg?imageView2/2/w/1620)

使用 ClusterControl，您可以：

-   在您选择的技术堆栈上部署独立的，复制的或群集的数据库。
-   跨多语言数据库和动态基础架构统一自动化故障转移，恢复和日常任务。
-   您可以创建完整或增量备份并计划它们。
-   对整个数据库和服务器基础结构进行统一和全面的实时监控。
-   只需一个操作即可轻松添加或删除节点。

在 PostgreSQL 上，如果发生事件，可以自动将您的从属提升为主状态。

它是一个非常完整的工具，带有免费的社区版本（还包括免费的企业试用版）。

![](https://ask.qcloudimg.com/http-save/yehe-1589852/9wn6e498g7.jpeg?imageView2/2/w/1620)

![](https://ask.qcloudimg.com/http-save/yehe-1589852/he4h61296n.jpeg?imageView2/2/w/1620)

异步，多主机，多平台复制（在 Ruby 或 JRuby 中实现）和多 DBMS（MySQL 或 PostgreSQL）的解决方案。

基于触发器，它不支持 DDL，用户或授权。

使用和管理的简单性是其主要目标。

一些功能：

-   配置简单
-   安装简单
-   平台独立，表格设计独立。

它是一种在 PostgreSQL 服务器和 PostgreSQL 数据库客户端之间工作的中间件。

一些功能：

-   连接池
-   复写
-   负载均衡
-   自动故障转移
-   并行查询

![](https://ask.qcloudimg.com/http-save/yehe-1589852/2bn2wtd5ci.jpeg?imageView2/2/w/1620)

基于行的异步级联主从复制，使用触发器在数据库中排队；基于行的异步主 - 主复制，基于行，使用触发器和自定义冲突解决方案。

Bucardo 需要专用的数据库并作为 Perl 守护程序运行，该守护程序与此数据库以及复制中涉及的所有其他数据库进行通信。它可以作为多主机或多从机运行。

主从复制涉及到一个或多个目标的一个或多个源。源必须是 PostgreSQL，但是目标可以是 PostgreSQL，MySQL，Redis，Oracle，[MariaDB](https://cloud.tencent.com/product/tdsql?from=10680)，SQLite 或[MongoDB](https://cloud.tencent.com/product/mongodb?from=10680)。

一些功能：

1.  负载均衡
2.  从站不受限制，可以写
3.  部分复制
4.  按需复制（更改可以自动或在需要时推送）
5.  从站可以 “预热” 以快速设置

缺点：

-   无法处理 DDL
-   无法处理大物件
-   没有唯一键无法增量复制表
-   不适用于 Postgres 8 之前的版本

Postgres-XC 是一个开源项目，旨在提供可写扩展，同步，对称和透明的 PostgreSQL 集群解决方案。它是紧密耦合的数据库组件的集合，可以将其安装在多个硬件或虚拟机中。

写可伸缩性意味着 Postgres-XC 可以配置任意数量的数据库服务器，并且与单个数据库服务器相比，可以处理更多的写操作（更新 SQL 语句）。

您可以有多个客户端连接到的数据库服务器，该服务器提供数据库的单个一致的群集范围视图。

来自任何数据库服务器的任何数据库更新对于在不同主服务器上运行的任何其他事务都是立即可见的。

透明意味着您不必担心内部如何将数据存储在多个数据库服务器中。

您可以配置 Postgres-XC 在多个服务器上运行。您为每个表选择的数据以分布式方式存储，即分区或复制。发出查询时，Postgres-XC 会确定目标数据的存储位置，并向包含目标数据的服务器发出相应的查询。

Citus 用内置的高可用性功能（例如自动分片和复制）替代了 PostgreSQL。Citus 分片将您的数据库分片，并在整个商品节点集群中复制每个分片的多个副本。如果群集中的任何节点不可用，Citus 会将所有写入或查询透明地重定向到其他一个包含受影响的分片副本的节点。

一些功能：

-   自动逻辑分片
-   内置复制
-   用于灾难恢复的数据中心感知复制
-   具有高级负载平衡功能的中查询容错

您可以增加由 PostgreSQL 支持的实时应用程序的正常运行时间，并最大程度地减少硬件故障对性能的影响。您可以使用内置的高可用性工具来实现此目标，从而最大程度地减少成本高昂且易于出错的手动干预。

它是一种无共享的多主群集解决方案，可以透明地在一组节点上分配表，并并行执行这些节点的查询。它具有一个称为全局事务管理器（GTM）的附加组件，用于提供群集的全局一致视图。该项目基于 PostgreSQL 9.5 版本。一些公司，例如 2ndQuadrant，为该产品提供商业支持。

PostgresXL 是可水平扩展的开源 SQL 数据库集群，具有足够的灵活性来处理各种数据库工作负载：

-   OLTP 写密集型工作负载
-   需要 MPP 并行性的商业智能
-   运营数据存储
-   键值存储
-   GIS 地理空间
-   混合工作负载环境
-   多租户提供商托管环境

组件：

-   全局事务监视器（GTM）：全局事务监视器确保群集范围内的事务一致性。
-   协调器：协调器管理用户会话并与 GTM 和数据节点进行交互。
-   数据节点：数据节点是存储实际数据的位置。

还有许多其他产品可以为 PostgreSQL 创建我们的高可用性环境，但是您必须注意以下几点：

-   新产品，未经充分测试
-   停产项目
-   局限性
-   许可费用
-   非常复杂的实现
-   不安全的解决方案

您还必须考虑您的基础架构。如果只有一台应用程序服务器，那么无论您配置了多少数据库的高可用性，如果应用程序服务器发生故障，则将无法访问。您必须很好地分析基础架构中的单点故障，并尝试解决它们。

考虑到这些要点，您可以找到一种适合您的需求和要求的解决方案，而不会产生麻烦，并且能够实施您的高可用性群集解决方案。来吧，祝你好运！

本文分享自微信公众号 - 首席架构师智库（jiagoushipro），作者：南极真君

原文出处及转载信息见文内详细说明，如有侵权，请联系 yunjia_community@tencent.com 删除。

原始发表时间：2021-02-01

本文参与[腾讯云自媒体分享计划](https://cloud.tencent.com/developer/support-plan)，欢迎正在阅读的你也加入，一起分享。 
 [https://cloud.tencent.com/developer/article/1785162](https://cloud.tencent.com/developer/article/1785162)
